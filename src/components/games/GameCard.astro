---
import type { Game } from "@/schemas/games";

interface Props extends Game {
  isFavourite?: boolean;
}

const {
  title,
  genres,
  platforms,
  cover,
  storePage,
  stats,
  isFavourite = false,
} = Astro.props;

const achievementPercent = stats?.achievements
  ? Math.round((stats.achievements.unlocked / stats.achievements.total) * 100)
  : null;

const isPerfect = achievementPercent === 100;

const starsValue = stats?.rating != null ? stats.rating / 2 : null;
const starFills =
  starsValue != null
    ? Array.from({ length: 5 }, (_, i) =>
        Math.min(100, Math.max(0, (starsValue - i) * 100)),
      )
    : null;

const platform = platforms[0];
---

<article
  class="group relative aspect-3/4 cursor-default overflow-hidden rounded-3xl transition-shadow duration-200 hover:shadow-(--shadow-glow-pink)"
>
  <div class="absolute inset-0">
    <img
      class="h-full w-full object-cover transition-transform duration-500 ease-in-out group-hover:scale-105"
      src={cover}
      alt={`${title} cover`}
      loading="lazy"
    />
  </div>

  <div
    class="absolute inset-0 flex flex-col justify-end opacity-0 transition-opacity duration-200 ease-in-out group-hover:opacity-100"
  >
    {
      isFavourite ? (
        <div class="bg-linear-to-t from-black/90 via-black/70 to-transparent px-6 pt-24 pb-6 backdrop-blur-sm">
          <h3 class="mb-1 font-serif text-2xl leading-tight text-white">
            {title}
          </h3>
          {genres.length > 0 && (
            <span class="mb-3 block font-mono text-xs tracking-widest text-white/50 uppercase">
              {genres[0]}
            </span>
          )}

          {stats && (
            <div class="flex flex-col gap-3">
              <div class="flex flex-wrap gap-6">
                {stats.hoursPlayed && (
                  <div class="flex flex-col">
                    <span class="font-mono text-xl leading-tight font-bold text-white">
                      {stats.hoursPlayed}
                    </span>
                    <span class="font-mono text-xs tracking-widest text-white/50 uppercase">
                      hours
                    </span>
                  </div>
                )}
                {stats.completionPercent !== undefined && (
                  <div class="flex flex-col">
                    <span class="font-mono text-xl leading-tight font-bold text-white">
                      {stats.completionPercent}%
                    </span>
                    <span class="font-mono text-xs tracking-widest text-white/50 uppercase">
                      complete
                    </span>
                  </div>
                )}
                <div class="flex flex-col">
                  <span class="font-mono text-xl leading-tight font-bold text-white">
                    {platform}
                  </span>
                  <span class="font-mono text-xs tracking-widest text-white/50 uppercase">
                    platform
                  </span>
                </div>
              </div>

              {stats.achievements && achievementPercent !== null && (
                <div class="flex flex-col gap-1.5">
                  <div class="flex items-center justify-between font-mono text-xs text-white/70">
                    <span>
                      Achievements: {stats.achievements.unlocked}/
                      {stats.achievements.total}
                    </span>
                    {isPerfect && (
                      <span
                        class="medal-shine inline-flex"
                        title="100% Achievements"
                      >
                        <svg
                          width="18"
                          height="18"
                          viewBox="0 0 24 24"
                          fill="none"
                          aria-hidden="true"
                        >
                          <circle
                            cx="12"
                            cy="9"
                            r="7"
                            fill="var(--color-golden-hour)"
                          />
                          <path
                            d="M8 18l-2 4h12l-2-4"
                            fill="var(--color-golden-hour)"
                            opacity="0.7"
                          />
                          <path
                            d="M12 5l1.5 3 3.5.5-2.5 2.5.5 3.5L12 13l-3 1.5.5-3.5L7 8.5l3.5-.5z"
                            fill="#fff"
                            opacity="0.9"
                          />
                        </svg>
                      </span>
                    )}
                  </div>
                  <div class="h-1.5 w-full overflow-hidden rounded-full bg-white/15">
                    <div
                      class:list={[
                        "h-full rounded-full transition-[width] duration-500",
                        isPerfect
                          ? "progress-perfect"
                          : "bg-(--portal-leisure)",
                      ]}
                      style={`width: ${achievementPercent}%`}
                    />
                  </div>
                </div>
              )}

              {starFills && (
                <div
                  class="flex gap-px"
                  aria-label={`Rating: ${stats.rating} out of 10`}
                >
                  {starFills.map((fillPercent) => (
                    <span
                      class="relative inline-block text-base leading-none"
                      aria-hidden="true"
                    >
                      <span class="text-white/20">&#9733;</span>
                      <span
                        class="absolute inset-0 overflow-hidden text-(--color-golden-hour)"
                        style={`width: ${fillPercent}%`}
                      >
                        &#9733;
                      </span>
                    </span>
                  ))}
                </div>
              )}
            </div>
          )}

          {storePage && (
            <a
              href={storePage}
              target="_blank"
              rel="noopener noreferrer"
              class="mt-3 inline-block font-mono text-sm text-(--portal-leisure) no-underline transition-colors duration-150 hover:text-white"
            >
              View on Store &rarr;
            </a>
          )}
        </div>
      ) : (
        <div class="bg-linear-to-t from-black/85 via-black/60 to-transparent px-4 pt-16 pb-4">
          <h3 class="mb-1 font-serif text-lg leading-snug text-white">
            {title}
          </h3>
          {genres.length > 0 && (
            <span class="mb-1 block font-mono text-xs tracking-wider text-white/60 uppercase">
              {genres[0]}
            </span>
          )}

          {stats && (
            <div class="mt-1.5 flex flex-col gap-1.5">
              <div class="flex items-center justify-between">
                <span class="font-mono text-xs text-white/70">{platform}</span>
                {stats.hoursPlayed && (
                  <span class="font-mono text-xs font-semibold text-white/90">
                    {stats.hoursPlayed}h
                  </span>
                )}
              </div>

              {stats.achievements && achievementPercent !== null && (
                <div class="flex flex-col gap-1">
                  <div class="flex items-center justify-between">
                    <span class="font-mono text-xs text-white/70">
                      {stats.achievements.unlocked}/{stats.achievements.total}
                    </span>
                    {isPerfect && (
                      <span
                        class="medal-shine inline-flex"
                        title="100% Achievements"
                      >
                        <svg
                          width="16"
                          height="16"
                          viewBox="0 0 24 24"
                          fill="none"
                          aria-hidden="true"
                        >
                          <circle
                            cx="12"
                            cy="9"
                            r="7"
                            fill="var(--color-golden-hour)"
                          />
                          <path
                            d="M8 18l-2 4h12l-2-4"
                            fill="var(--color-golden-hour)"
                            opacity="0.7"
                          />
                          <path
                            d="M12 5l1.5 3 3.5.5-2.5 2.5.5 3.5L12 13l-3 1.5.5-3.5L7 8.5l3.5-.5z"
                            fill="#fff"
                            opacity="0.9"
                          />
                        </svg>
                      </span>
                    )}
                  </div>
                  <div class="h-1 w-full overflow-hidden rounded-full bg-white/15">
                    <div
                      class:list={[
                        "h-full rounded-full transition-[width] duration-500",
                        isPerfect
                          ? "progress-perfect"
                          : "bg-(--portal-leisure)",
                      ]}
                      style={`width: ${achievementPercent}%`}
                    />
                  </div>
                </div>
              )}

              {starFills && (
                <div
                  class="flex gap-px"
                  aria-label={`Rating: ${stats.rating} out of 10`}
                >
                  {starFills.map((fillPercent) => (
                    <span
                      class="relative inline-block text-sm leading-none"
                      aria-hidden="true"
                    >
                      <span class="text-white/20">&#9733;</span>
                      <span
                        class="absolute inset-0 overflow-hidden text-(--color-golden-hour)"
                        style={`width: ${fillPercent}%`}
                      >
                        &#9733;
                      </span>
                    </span>
                  ))}
                </div>
              )}
            </div>
          )}

          {storePage && (
            <a
              href={storePage}
              target="_blank"
              rel="noopener noreferrer"
              class="mt-2 inline-block font-mono text-xs text-(--portal-leisure) no-underline transition-colors duration-150 hover:text-white"
            >
              View &rarr;
            </a>
          )}
        </div>
      )
    }
  </div>
</article>

<style>
  .medal-shine {
    filter: drop-shadow(0 0 4px rgba(255, 215, 0, 0.6));
    animation: medalShine 3s ease-in-out infinite;
  }

  .progress-perfect {
    background: linear-gradient(
      90deg,
      var(--color-golden-hour),
      var(--color-amber-glow)
    );
    box-shadow: 0 0 6px rgba(255, 215, 0, 0.5);
  }

  @keyframes medalShine {
    0%,
    100% {
      filter: drop-shadow(0 0 4px rgba(255, 215, 0, 0.6));
    }
    50% {
      filter: drop-shadow(0 0 8px rgba(255, 215, 0, 0.9));
    }
  }

  @media (prefers-reduced-motion: reduce) {
    .medal-shine {
      animation: none;
    }
  }
</style>
